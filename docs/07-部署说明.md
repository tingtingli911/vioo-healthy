# 部署说明

## 环境要求

### 开发环境
- **Docker**：用于运行 MySQL
- **Node.js**：18+（用于前端开发）
- **Python**：3.11+（用于后端开发）

### 生产环境
- **Docker**：20.10+
- **Docker Compose**：2.0+

## 环境变量配置

### 创建 .env 文件
在项目根目录创建 `.env` 文件：

```bash
cp .env.example .env
```

### 环境变量说明

#### 数据库配置
```env
DB_NAME=healthy              # 数据库名称
DB_USER=root                # 数据库用户名
DB_PASSWORD=your-password   # 数据库密码
DB_HOST=127.0.0.1          # 数据库主机（开发环境）
DB_PORT=3007               # 数据库端口（开发环境）
```

#### Django 配置
```env
SECRET_KEY=your-secret-key-here  # Django 密钥（生产环境必须修改）
DEBUG=True                        # 调试模式（生产环境设为 False）
```

#### Docker 镜像标签（部署时使用）
```env
BACKEND_IMAGE=healthy-backend:latest
FRONTEND_IMAGE=healthy-frontend:latest
```

## 开发环境部署

### 一键启动
```bash
./scripts/dev.sh
```

这个脚本会自动：
1. 启动 MySQL 数据库容器
2. 检查并安装前后端依赖
3. 创建后端虚拟环境（如需要）
4. 运行数据库迁移
5. 启动前端开发服务器（端口 3008）
6. 启动后端开发服务器（端口 3009）

### 访问地址
- **前端**：http://localhost:3008
- **后端 API**：http://localhost:3009/api/hello/

### 查看日志
```bash
# 查看前端日志
tail -f .frontend.log

# 查看后端日志
tail -f .backend.log
```

### 停止服务
```bash
# 停止开发服务器
./scripts/stop.sh

# 停止 MySQL 容器
docker-compose down
```

## 生产环境部署

### 1. 构建 Docker 镜像

#### 构建所有镜像
```bash
./scripts/build.sh
```

#### 指定镜像标签
```bash
./scripts/build.sh healthy-frontend:v1.0.0 healthy-backend:v1.0.0
```

### 2. 配置环境变量

确保 `.env` 文件中的配置正确：
- `DEBUG=False`（生产环境）
- `SECRET_KEY` 设置为强随机字符串
- `DB_PASSWORD` 设置为强密码

### 3. 部署到服务器

#### 使用默认镜像
```bash
./scripts/deploy.sh
```

#### 指定镜像
```bash
export FRONTEND_IMAGE=healthy-frontend:v1.0.0
export BACKEND_IMAGE=healthy-backend:v1.0.0
./scripts/deploy.sh
```

### 4. 访问地址

- **前端**：http://localhost:80
- **后端 API**：http://localhost:8000/api/hello/
- **Nginx 代理**：http://localhost:8080

### 5. 服务管理

#### 查看服务状态
```bash
docker-compose -f docker-compose.deploy.yml ps
```

#### 查看日志
```bash
# 查看所有服务日志
docker-compose -f docker-compose.deploy.yml logs -f

# 查看特定服务日志
docker-compose -f docker-compose.deploy.yml logs -f backend
docker-compose -f docker-compose.deploy.yml logs -f frontend
```

#### 停止服务
```bash
docker-compose -f docker-compose.deploy.yml down
```

#### 重启服务
```bash
docker-compose -f docker-compose.deploy.yml restart
```

#### 更新服务
```bash
# 1. 构建新镜像
./scripts/build.sh

# 2. 停止旧服务
docker-compose -f docker-compose.deploy.yml down

# 3. 启动新服务
./scripts/deploy.sh
```

## Docker 配置说明

### docker-compose.yml（开发环境）
用于本地开发，只包含 MySQL 服务。

### docker-compose.deploy.yml（生产环境）
包含所有服务：
- **mysql**：MySQL 数据库
- **backend**：Django 后端服务
- **frontend**：Vue 前端服务（Nginx）
- **nginx**：反向代理服务器

## 端口说明

### 开发环境端口
- **3007**：MySQL 数据库
- **3008**：前端开发服务器
- **3009**：后端开发服务器

### 生产环境端口
- **80**：前端服务（Nginx）
- **8000**：后端服务（Django）
- **8080**：Nginx 反向代理
- **3306**：MySQL 数据库（内部）

## 数据库初始化

### 首次部署
首次部署时会自动：
1. 创建数据库（如果不存在）
2. 运行数据库迁移
3. 创建超级用户（可选）

### 手动初始化
```bash
# 进入后端容器
docker-compose -f docker-compose.deploy.yml exec backend bash

# 运行迁移
python manage.py migrate

# 创建超级用户（可选）
python manage.py createsuperuser
```

## Nginx 配置

### 前端 Nginx 配置
位置：`frontend/nginx.conf`

### 反向代理 Nginx 配置
位置：`nginx/conf.d/default.conf`

### 修改配置后
```bash
# 重启 Nginx 容器
docker-compose -f docker-compose.deploy.yml restart nginx
```

## 备份和恢复

### 数据库备份
```bash
# 备份数据库
docker-compose -f docker-compose.deploy.yml exec mysql mysqldump -u root -p healthy > backup.sql

# 恢复数据库
docker-compose -f docker-compose.deploy.yml exec -T mysql mysql -u root -p healthy < backup.sql
```

## 故障排查

### 常见问题

#### 1. 端口被占用
```bash
# 检查端口占用
lsof -i :3008
lsof -i :3009

# 停止占用端口的进程
kill -9 <PID>
```

#### 2. 数据库连接失败
- 检查 `.env` 文件中的数据库配置
- 检查 MySQL 容器是否正常运行
- 检查数据库密码是否正确

#### 3. 前端无法访问后端
- 检查后端服务是否正常运行
- 检查 Nginx 配置是否正确
- 检查 CORS 配置

#### 4. Token 认证失败
- 检查 Token 是否过期（7天有效期）
- 检查请求头格式：`Authorization: Bearer <token>`
- 检查后端日志查看具体错误

### 查看详细日志
```bash
# 后端日志
docker-compose -f docker-compose.deploy.yml logs backend

# 前端日志
docker-compose -f docker-compose.deploy.yml logs frontend

# 数据库日志
docker-compose -f docker-compose.deploy.yml logs mysql
```

## 安全建议

### 生产环境必须配置
1. **修改 SECRET_KEY**：使用强随机字符串
2. **设置 DEBUG=False**：关闭调试模式
3. **修改数据库密码**：使用强密码
4. **配置 HTTPS**：使用 SSL 证书
5. **配置防火墙**：只开放必要端口
6. **定期备份**：设置数据库自动备份

### 安全检查清单
- [ ] SECRET_KEY 已修改
- [ ] DEBUG 已关闭
- [ ] 数据库密码已修改
- [ ] HTTPS 已配置
- [ ] 防火墙已配置
- [ ] 备份机制已设置

---

**最后更新**：2025-01-27
