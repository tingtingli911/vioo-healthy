# 数据库设计

## 数据库信息

- **数据库类型**：MySQL 8.0
- **数据库名称**：`healthy`
- **字符集**：utf8mb4
- **排序规则**：utf8mb4_unicode_ci

## 数据表设计

### 1. users 表（用户表）

**表名**：`users`

**字段说明**：

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| username | VARCHAR(150) | UNIQUE, NOT NULL | 用户名 |
| password | VARCHAR(255) | NOT NULL | 密码（明文存储） |
| is_superuser | BOOLEAN | NOT NULL, DEFAULT FALSE | 是否超级管理员 |
| created_at | DATETIME | NOT NULL, AUTO_ADD | 创建时间 |
| updated_at | DATETIME | NOT NULL, AUTO_UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (`id`)
- UNIQUE KEY (`username`)

**模型定义**：`backend/users/models.py::User`

**特殊说明**：
- 密码当前为明文存储（后续版本会改为加密存储）
- 第一个注册的用户自动设置 `is_superuser=True`
- `created_at` 和 `updated_at` 由 Django 自动管理

---

### 2. tokens 表（Token 表）

**表名**：`tokens`

**字段说明**：

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | Token ID |
| user_id | BIGINT | FOREIGN KEY, NOT NULL | 用户ID（关联 users.id） |
| token | VARCHAR(40) | UNIQUE, NOT NULL, INDEX | Token 值 |
| created_at | DATETIME | NOT NULL, AUTO_ADD | 创建时间 |
| expires_at | DATETIME | NOT NULL | 过期时间 |

**索引**：
- PRIMARY KEY (`id`)
- UNIQUE KEY (`token`)
- INDEX (`token`)
- INDEX (`user_id`, `expires_at`)

**外键关系**：
- `user_id` → `users.id` (ON DELETE CASCADE)

**模型定义**：`backend/users/models.py::Token`

**特殊说明**：
- Token 长度为 40 个字符（大小写字母 + 数字）
- Token 有效期为 7 天
- 创建新 Token 时会自动删除该用户的过期 Token
- Token 过期后需要重新登录

---

## 数据关系图

```
users (用户表)
  │
  │ 1:N
  │
  ▼
tokens (Token表)
```

**关系说明**：
- 一个用户可以有多个 Token（但通常只有一个有效的）
- Token 通过 `user_id` 关联到用户
- 删除用户时会级联删除该用户的所有 Token

## 数据库迁移

### 迁移文件位置
`backend/users/migrations/`

### 已应用的迁移
1. `0001_initial.py` - 创建 users 和 tokens 表
2. `0002_user_is_superuser.py` - 添加 is_superuser 字段

### 创建迁移
```bash
cd backend
python manage.py makemigrations
```

### 应用迁移
```bash
python manage.py migrate
```

## 数据模型代码

### User 模型
```python
class User(models.Model):
    username = models.CharField(max_length=150, unique=True)
    password = models.CharField(max_length=255)
    is_superuser = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

### Token 模型
```python
class Token(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    token = models.CharField(max_length=40, unique=True, db_index=True)
    created_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField()
```

## 数据库操作示例

### 创建用户
```python
user = User.objects.create(
    username='testuser',
    password='123456',
    is_superuser=False
)
```

### 创建 Token
```python
token_obj = Token.create_token(user)
# 自动设置 7 天有效期
# 自动删除该用户的过期 Token
```

### 查询用户
```python
# 根据用户名查询
user = User.objects.get(username='testuser')

# 查询所有超级管理员
superusers = User.objects.filter(is_superuser=True)

# 查询用户总数
total = User.objects.count()
```

### 验证 Token
```python
token_obj = Token.objects.select_related('user').get(token=token_string)
if token_obj.is_expired():
    # Token 已过期
    pass
else:
    user = token_obj.user
```

## 数据库配置

### 开发环境配置
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'healthy',
        'USER': 'root',
        'PASSWORD': 'password',
        'HOST': '127.0.0.1',
        'PORT': '3007',
    }
}
```

### 生产环境配置
通过环境变量配置：
- `DB_NAME` - 数据库名称
- `DB_USER` - 数据库用户
- `DB_PASSWORD` - 数据库密码
- `DB_HOST` - 数据库主机（Docker 环境为 `mysql`）
- `DB_PORT` - 数据库端口（Docker 环境为 `3306`）

## 数据安全

### 当前安全措施
1. **密码存储**：⚠️ 当前为明文存储，后续版本需要加密
2. **Token 安全**：Token 使用随机生成，40 位字符
3. **Token 过期**：7 天有效期，过期后自动失效
4. **级联删除**：删除用户时自动删除相关 Token

### 建议改进
1. **密码加密**：使用 Django 的密码哈希（`make_password`）
2. **Token 刷新**：实现 Token 刷新机制
3. **登录日志**：记录用户登录日志
4. **密码策略**：加强密码复杂度要求

---

**最后更新**：2025-01-27
